{% extends 'base.html' %}

{% block content %}

<!-- Page content-->
<div class="container">
    <div class="row">
        <div class="col-lg-8">
            <!-- Post content-->
            <article>
                <!-- Post header-->
                <header class="mb-4">
                    <!-- Post title-->
                    <a href="{% url 'blogspage' post.slug %}" style="color: black; text-decoration: none;"><h1 class="fw-bolder mb-1">{{post.title}}</h1></a>
                    <!-- Post meta content-->
                    <div class="text-muted fst-italic mb-2">Posted on {{post.created_at}} by {{post.author}}</div>
                    <!-- Post category-->
                    <a class="badge bg-warning text-decoration-none text-dark" href="#!">{{post.category}}</a>
                    <!-- Post Description -->
                    <p class="fs-5 mb-4">{{post.short_description}}</p>
                </header>
                <!-- Preview image figure-->
                <figure class="mb-4"><img class="img-fluid rounded" style="width: 100%; height: auto; max-height: 900px; object-fit: contain;" src="{{post.featured_image.url}}" alt="..." /></figure>
                <!-- Post content-->
                <section class="mb-5">
                    <p class="fs-5 mb-4">{{post.blog_body}}</p>

                    <!-- comments -->
                <h4 class="mb-4">Comments ({{ comments|length }})</h4>
                <div id="comments-wrapper">
                {% if user.is_authenticated %}
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <form method="post" action="{% url 'blogspage' post.slug %}">
                            {% csrf_token %}
                            <div class="input-group">
                                {{ form.comment }}
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info">
                        Please 
                        <a href="{% url 'login' %}">
                            login
                        </a> 
                        to write a comment.
                </div>
                {% endif %}
                    {% if comments %}
                        {% for comment in comments %}
                            <div class="card mb-3 comment-item {% if forloop.counter > 2 %}d-none extra-comment{% endif %}">
                                <div class="card-body">              
                                    <!-- Header -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <strong>{{ comment.user }}</strong>
                                            <small class="text-muted ml-2">
                                                {{ comment.created_at|timesince }} ago
                                            </small>
                                        </div>
                                    </div>
                                    <!-- Comment Text -->
                                    <p class="mb-2">{{ comment }}</p>
                                    <!-- Like Section -->
                                    <div>
                                        {% if user.is_authenticated %}
                                        <form method="post" action="{% url 'like' comment.id %}" style="display:inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm {% if user in comment.likes.all %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                                    <i class="fas fa-thumbs-up"></i>
                                                </button>
                                        </form> 
                                            {% else %}
                                                <a href="{% url 'login' %}?next={{ request.path }}"
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-thumbs-up"></i>
                                                </a>
                                            {% endif %}                      
                                            <small class="text-muted ml-2">
                                                {{ comment.likes.count }} likes
                                            </small>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                        {% if comments|length > 2 %}
                            <div class="text-center">
                                <button id="toggle-comments-btn" class="btn btn-outline-secondary btn-sm">
                                    Load more
                                </button>
                            </div>
                        {% endif %}
                    {% else %}
                        <h5 class="text-muted">No comments yet...</h5>
                    {% endif %}
            </div>
        </section>
    </article>
</div>
        <!-- Side widgets-->
        <div class="col-lg-4">
             {% if social %}
            <div class="card mb-4 p-3">
                <h4 class="font-italic">Follow Us</h4>
                <ol class="list-unstyled">
            {% for i in social %}
            <li><a href="{{i.links}}">{{i}}</a></li>
            {% endfor %}
                </ol>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<script>
    const toggleBtn = document.getElementById("toggle-comments-btn");

    if (toggleBtn) {
        toggleBtn.addEventListener("click", function () {

            const hiddenComments = document.querySelectorAll(".extra-comment");
            const isExpanded = this.dataset.expanded === "true";

            hiddenComments.forEach(function (el) {
                el.classList.toggle("d-none");
            });

            if (isExpanded) {
                this.textContent = "Load More";
                this.dataset.expanded = "false";
            } else {
                this.textContent = "Read Less";
                this.dataset.expanded = "true";
            }
        });
    }
</script>

{% endblock %}